name: Release

on:
  push:
    tags: ["v*"]

jobs:
  build:
    name: Build Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --- Verify tag matches pyproject.toml version ---
      - name: Verify tag matches package version
        run: |
          tag="${GITHUB_REF#refs/tags/v}"
          version=$(grep '^version' apps/vuln-api/pyproject.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          if [ "$tag" != "$version" ]; then
            echo "::error::Tag v$tag does not match pyproject.toml version $version"
            exit 1
          fi

      # --- Node / pnpm ---
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      # --- Python / uv ---
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: apps/vuln-api/uv.lock

      # --- Build SPA ---
      - run: pnpm install --frozen-lockfile
      - run: pnpm nx run vuln-web:build:bundle

      # --- Verify SPA output ---
      - name: Verify SPA bundle exists
        run: test -f apps/vuln-api/app/web_dist/index.html

      # --- Build wheel ---
      - name: Build wheel
        working-directory: apps/vuln-api
        run: uv build

      # --- Verify wheel contents ---
      - name: Verify wheel contains web_dist
        working-directory: apps/vuln-api
        run: |
          wheel=$(ls dist/*.whl)
          python -m zipfile -l "$wheel" | grep web_dist/

      # --- Upload artifacts ---
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: apps/vuln-api/dist/

  publish:
    name: Publish to PyPI
    needs: build
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      - uses: pypa/gh-action-pypi-publish@release/v1

  github-release:
    name: GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      - uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: dist/*
